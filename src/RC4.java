/**
 * RC4 (Rivest Cipher 4) Stream Cipher Implementation
 * 
 * RC4 –µ —Å–∏–º–µ—Ç—Ä–∏—á–µ–Ω –ø–æ—Ç–æ—á–µ–Ω —à–∏—Ñ—ä—Ä, —Ä–∞–∑—Ä–∞–±–æ—Ç–µ–Ω –æ—Ç –†–æ–Ω –†–∏–≤–µ—Å—Ç –ø—Ä–µ–∑ 1987 –≥.
 * –ò–∑–ø–æ–ª–∑–≤–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞ –¥—ä–ª–∂–∏–Ω–∞ –Ω–∞ –∫–ª—é—á–∞ (–æ–±–∏–∫–Ω–æ–≤–µ–Ω–æ 40-256 –±–∏—Ç–∞).
 * 
 * –í–ù–ò–ú–ê–ù–ò–ï: RC4 –µ –æ—Å—Ç–∞—Ä—è–ª –∏ –Ω–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –≤ –Ω–æ–≤–∏ –ø—Ä–æ–µ–∫—Ç–∏ –ø–æ—Ä–∞–¥–∏
 * –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–∑–≤–µ—Å—Ç–Ω–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (FMS –∞—Ç–∞–∫–∞, bias –≤ –Ω–∞—á–∞–ª–Ω–∏—Ç–µ –±–∞–π—Ç–æ–≤–µ –∏ –¥—Ä.)
 * 
 * –¢–∞–∑–∏ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è –µ —Å–∞–º–æ –∑–∞ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–Ω–∏ —Ü–µ–ª–∏ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è.
 * 
 * @author –ö—É—Ä—Å–æ–≤–∞ —Ä–∞–±–æ—Ç–∞ –ø–æ –êS–ö
 * @version 1.0
 */
public class RC4 {

    private int[] S; // Substitution box (state array) - 256 –µ–ª–µ–º–µ–Ω—Ç–∞
    private int i, j; // –ò–Ω–¥–µ–∫—Å–∏ –∑–∞ PRGA –∞–ª–≥–æ—Ä–∏—Ç—ä–º–∞

    /**
     * –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞ RC4 —Å –¥–∞–¥–µ–Ω –∫–ª—é—á
     * 
     * @param key –±–∞–π—Ç–æ–≤ –º–∞—Å–∏–≤ —Å—ä–¥—ä—Ä–∂–∞—â –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—Å–∫–∏—è –∫–ª—é—á
     * @throws IllegalArgumentException –∞–∫–æ –∫–ª—é—á—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω –∏–ª–∏ null
     */
    public RC4(byte[] key) {
        if (key == null || key.length == 0) {
            throw new IllegalArgumentException("–ö–ª—é—á—ä—Ç –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –ø—Ä–∞–∑–µ–Ω");
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ S-box (Key Scheduling Algorithm)
        initializeState(key);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∏–Ω–¥–µ–∫—Å–∏—Ç–µ
        this.i = 0;
        this.j = 0;
    }

    /**
     * Key Scheduling Algorithm (KSA)
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞ –≤—ä—Ç—Ä–µ—à–Ω–æ—Ç–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ (S-box) –≤—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞ –∫–ª—é—á–∞
     * 
     * –ê–ª–≥–æ—Ä–∏—Ç—ä–º:
     * 1. –ó–∞–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ S —Å –∏–¥–µ–Ω—Ç–∏—Ç–µ—Ç–Ω–∞ –ø–µ—Ä–º—É—Ç–∞—Ü–∏—è (0-255)
     * 2. –†–∞–∑–º–µ—Å–≤–∞–Ω–µ –Ω–∞ S –≤—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞ –∫–ª—é—á–∞
     * 
     * @param key –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ—Å–∫–∏—è—Ç –∫–ª—é—á
     */
    private void initializeState(byte[] key) {
        S = new int[256];
        int keyLength = key.length;

        // –°—Ç—ä–ø–∫–∞ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ S —Å 0, 1, 2, ..., 255
        for (int i = 0; i < 256; i++) {
            S[i] = i;
        }

        // –°—Ç—ä–ø–∫–∞ 2: –†–∞–∑–º–µ—Å–≤–∞–Ω–µ –Ω–∞ S –≤—ä–∑ –æ—Å–Ω–æ–≤–∞ –Ω–∞ –∫–ª—é—á–∞
        int j = 0;
        for (int i = 0; i < 256; i++) {
            // –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ –Ω–æ–≤–∏—è –∏–Ω–¥–µ–∫—Å j
            j = (j + S[i] + (key[i % keyLength] & 0xFF)) % 256;

            // –†–∞–∑–º—è–Ω–∞ –Ω–∞ S[i] –∏ S[j]
            swap(i, j);
        }
    }

    /**
     * –†–∞–∑–º—è–Ω–∞ –Ω–∞ –¥–≤–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ S-box
     * 
     * @param i –ø—ä—Ä–≤–∏ –∏–Ω–¥–µ–∫—Å
     * @param j –≤—Ç–æ—Ä–∏ –∏–Ω–¥–µ–∫—Å
     */
    private void swap(int i, int j) {
        int temp = S[i];
        S[i] = S[j];
        S[j] = temp;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä–∞ —Å–ª–µ–¥–≤–∞—â–∏—è –±–∞–π—Ç –æ—Ç keystream
     * Pseudo-Random Generation Algorithm (PRGA)
     * 
     * –ê–ª–≥–æ—Ä–∏—Ç—ä–º:
     * 1. i = (i + 1) mod 256
     * 2. j = (j + S[i]) mod 256
     * 3. swap(S[i], S[j])
     * 4. K = S[(S[i] + S[j]) mod 256]
     * 
     * @return —Å–ª–µ–¥–≤–∞—â –±–∞–π—Ç –æ—Ç –∫–ª—é—á–æ–≤–∏—è –ø–æ—Ç–æ–∫
     */
    private byte nextKeystreamByte() {
        // –£–≤–µ–ª–∏—á–∞–≤–∞–Ω–µ –Ω–∞ i
        i = (i + 1) % 256;

        // –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ j
        j = (j + S[i]) % 256;

        // –†–∞–∑–º—è–Ω–∞ –Ω–∞ S[i] –∏ S[j]
        swap(i, j);

        // –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –∏–∑—Ö–æ–¥–µ–Ω –±–∞–π—Ç
        int index = (S[i] + S[j]) % 256;
        return (byte) S[index];
    }

    /**
     * –ö—Ä–∏–ø—Ç–∏—Ä–∞/–¥–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞ –¥–∞–Ω–Ω–∏
     * RC4 –∏–∑–ø–æ–ª–∑–≤–∞ XOR, —Ç–∞–∫–∞ —á–µ –∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ—Ç–æ –∏ –¥–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ—Ç–æ —Å–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–∏
     * 
     * @param data –¥–∞–Ω–Ω–∏—Ç–µ –∑–∞ –∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ/–¥–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ
     * @return –∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–∏—Ç–µ/–¥–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏
     */
    public byte[] crypt(byte[] data) {
        byte[] result = new byte[data.length];

        for (int k = 0; k < data.length; k++) {
            // XOR –Ω–∞ –≤—Å–µ–∫–∏ –±–∞–π—Ç –æ—Ç –¥–∞–Ω–Ω–∏—Ç–µ —Å –±–∞–π—Ç –æ—Ç keystream
            result[k] = (byte) (data[k] ^ nextKeystreamByte());
        }

        return result;
    }

    /**
     * –ö—Ä–∏–ø—Ç–∏—Ä–∞ —Ç–µ–∫—Å—Ç
     * 
     * @param plaintext –æ—Ç–∫—Ä–∏—Ç–∏—è—Ç —Ç–µ–∫—Å—Ç
     * @return –∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–∏ –±–∞–π—Ç–æ–≤–µ
     */
    public byte[] encrypt(String plaintext) {
        return crypt(plaintext.getBytes());
    }

    /**
     * –î–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞ –¥–∞–Ω–Ω–∏ –∫—ä–º —Ç–µ–∫—Å—Ç
     * 
     * @param ciphertext –∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω–∏
     * @return –¥–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–∏—è—Ç —Ç–µ–∫—Å—Ç
     */
    public String decrypt(byte[] ciphertext) {
        return new String(crypt(ciphertext));
    }

    /**
     * Reset –Ω–∞ —à–∏—Ñ—ä—Ä–∞ —Å—ä—Å —Å—ä—â–∏—è –∫–ª—é—á
     * –ü–æ–ª–µ–∑–Ω–æ –∑–∞ –∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—ä–æ–±—â–µ–Ω–∏—è
     * 
     * @param key –∫–ª—é—á—ä—Ç –∑–∞ —Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
     */
    public void reset(byte[] key) {
        initializeState(key);
        this.i = 0;
        this.j = 0;
    }

    /**
     * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞ –±–∞–π—Ç–æ–≤ –º–∞—Å–∏–≤ –≤ hexadecimal string –∑–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
     * 
     * @param bytes –±–∞–π—Ç–æ–≤–∏—è—Ç –º–∞—Å–∏–≤
     * @return hex –ø—Ä–µ–¥—Å—Ç–∞–≤—è–Ω–µ
     */
    public static String bytesToHex(byte[] bytes) {
        StringBuilder sb = new StringBuilder();
        for (byte b : bytes) {
            sb.append(String.format("%02X", b));
        }
        return sb.toString();
    }

    /**
     * –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–µ–Ω –ø—Ä–∏–º–µ—Ä –∑–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ RC4
     */
    public static void main(String[] args) {
        System.out.println("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
        System.out.println("‚ïë          RC4 Stream Cipher - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è                  ‚ïë");
        System.out.println("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");

        // –¢–µ—Å—Ç–æ–≤–∏ –¥–∞–Ω–Ω–∏
        String secretKey = "MySecretKey123";
        String plaintext = "–¢–æ–≤–∞ –µ —Ç–∞–π–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –∑–∞ –∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ —Å RC4!";

        System.out.println("üìù –û—Ä–∏–≥–∏–Ω–∞–ª–µ–Ω —Ç–µ–∫—Å—Ç:");
        System.out.println("   " + plaintext);
        System.out.println();

        // –ö—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ
        RC4 cipher = new RC4(secretKey.getBytes());
        byte[] encrypted = cipher.encrypt(plaintext);

        System.out.println("üîê –ö—Ä–∏–ø—Ç–∏—Ä–∞–Ω (Hex):");
        System.out.println("   " + bytesToHex(encrypted));
        System.out.println();

        // –î–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ
        cipher.reset(secretKey.getBytes()); // Reset –∑–∞ –¥–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω–µ
        String decrypted = cipher.decrypt(encrypted);

        System.out.println("üîì –î–µ–∫—Ä–∏–ø—Ç–∏—Ä–∞–Ω —Ç–µ–∫—Å—Ç:");
        System.out.println("   " + decrypted);
        System.out.println();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –∫–æ—Ä–µ–∫—Ç–Ω–æ—Å—Ç
        boolean success = plaintext.equals(decrypted);
        System.out.println("‚úì –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: " + (success ? "–£–°–ü–ï–®–ù–ê ‚úì" : "–ì–†–ï–®–ö–ê ‚úó"));
        System.out.println();

        // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –∫–ª—é—á–æ–≤–µ
        System.out.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        System.out.println("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω–∏ –¥—ä–ª–∂–∏–Ω–∏ –Ω–∞ –∫–ª—é—á–æ–≤–µ:");
        System.out.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");

        String[] keys = {
                "Key1", // 32 –±–∏—Ç–∞
                "MyKey123", // 72 –±–∏—Ç–∞
                "LongerKey1234567890", // 160 –±–∏—Ç–∞
                "VeryLongSecretKey1234567890ABCDEF" // 256 –±–∏—Ç–∞
        };

        for (String key : keys) {
            RC4 testCipher = new RC4(key.getBytes());
            byte[] testEncrypted = testCipher.encrypt("Test");

            System.out.printf("–ö–ª—é—á: %-35s | –î—ä–ª–∂–∏–Ω–∞: %3d –±–∏—Ç–∞ | Encrypted: %s%n",
                    key, key.length() * 8, bytesToHex(testEncrypted));
        }

        System.out.println();
        System.out.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
        System.out.println("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: RC4 –µ –æ—Å—Ç–∞—Ä—è–ª –∏ –Ω–µ—Å–∏–≥—É—Ä–µ–Ω!");
        System.out.println("    –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ ChaCha20 –∏–ª–∏ AES-GCM –∑–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–æ–Ω–Ω–∏ —Å–∏—Å—Ç–µ–º–∏.");
        System.out.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    }
}
